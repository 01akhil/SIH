<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentor Dashboard</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        nav {
            height: 10vh;
            width: 100vw;
            background-color: #333;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            display: flex;
            height: 90vh;
            width: 100vw;
        }
        .left-panel {
            height: 100%;
            width: 75vw;
            overflow-y: auto;
        }
        .right-panel {
            height: 100%;
            width: 25vw;
            background-color: #f4f4f4;
            padding: 20px;
            overflow-y: auto;
        }
        .slot {
            margin-bottom: 10px;
        }
        .remove-btn {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        .add-btn {
            background-color: green;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        .link-container {
            margin-top: 20px;
        }
        .link-container p {
            margin: 10px 0;
            font-weight: bold;
        }
        .session-container {
            margin-top: 20px;
        }
        .session-container p {
            font-weight: bold;
        }
        .session-container div {
            margin-bottom: 10px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: gray;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-track {
            background-color: #f4f4f4;
        }

    </style>
</head>
<body style="font-family: Arial, sans-serif; background-color: #f4f4f4; color: #333; overflow-x: hidden;">
    <nav>
        <p id="mentor-id"></p>
    </nav>
    <div class="container">
        <div class="left-panel" style="overflow-x: hidden;">
            <div class="blog">
        
                <header style="width: 100%; height: 10vh; background-color: #0077b6; display: flex; align-items: center; justify-content: space-around; padding: 0 20px; color: #fff;">
                    <div style="font-size: 1.5rem;">Hello</div>
                    <div style="font-size: 1.5rem;">Login</div>
                </header>
        
                <div style="width: 100%; height: 60vh; background-color: #1a1e21; color: white; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center;">
                    <h1 style="font-size: 3rem; margin-bottom: 10px;">The Blog</h1>
                    <h6 style="font-size: 1.2rem; font-weight: 300; color: #ccc;">Your source of great content</h6>
                </div>
        
                <div style="display: flex; justify-content: center; align-items: center; height: 30vh; background-color: #005792;">
                    <button style="background-color: #fff; color: #005792; border: none; padding: 10px 20px; margin: 0 10px; font-size: 1rem; border-radius: 5px; cursor: pointer;">All</button>
                    <button style="background-color: #fff; color: #005792; border: none; padding: 10px 20px; margin: 0 10px; font-size: 1rem; border-radius: 5px; cursor: pointer;">Tech</button>
                    <button style="background-color: #fff; color: #005792; border: none; padding: 10px 20px; margin: 0 10px; font-size: 1rem; border-radius: 5px; cursor: pointer;">Marketing</button>
                    <button style="background-color: #fff; color: #005792; border: none; padding: 10px 20px; margin: 0 10px; font-size: 1rem; border-radius: 5px; cursor: pointer;">Design</button>
                </div>
        
                <div style="width: 100%; height: 100vh; background-color: #f0f8ff; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px;">
                    <h1 style="margin-bottom: 20px;">Add a new post</h1>
        
                    <form id="new-post-form" style="display: flex; flex-direction: column; width: 50%; max-width: 600px;">
                        <label for="post-title"  style="margin-bottom: 5px;">Title:</label>
                        <input type="text" id="post-title" name="title" required style="padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px;">
        
                        <label for="post-content" style="margin-bottom: 5px;">Content:</label>
                        <textarea id="post-content" name="content" required style="padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; height: 100px;"></textarea>
        
                        <label for="post-author" style="margin-bottom: 5px;">Author:</label>
                        <input type="text" id="post-author" name="author" required style="padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px;">
        
                        <label for="post-category" style="margin-bottom: 5px;">Category:</label>
                        <select id="post-category" name="category" required style="padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px;">
                            <option value="tech">Tech</option>
                            <option value="marketing">Marketing</option>
                            <option value="design">Design</option>
                        </select>
        
                        <button id="submit-blog" type="submit" style="padding: 10px 20px; background-color: #0077b6; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;">Submit</button>
                    </form>
                </div>
        
                <div class="footer container" style="height: 10vh; width: 100%; background-color: #0077b6; color: #fff; display: flex; align-items: center; justify-content: center; padding: 0 20px;">
                    <p style="margin: 0;">&#169; AD All Rights Reserved</p>
                    <div class="social" style="display: flex; gap: 10px; margin-left: 20px;">
                        <a href="#" style="color: #fff;"><i class='bx bxl-facebook'></i> Facebook</a>
                        <a href="#" style="color: #fff;"><i class='bx bxl-twitter'></i> Twitter</a>
                        <a href="#" style="color: #fff;"><i class='bx bxl-instagram'></i> Instagram</a>
                        <a href="#" style="color: #fff;"><i class='bx bxl-linkedin'></i> LinkedIn</a>
                    </div>
                </div>
        
            </div>
        
        </div>

        <div class="right-panel">
            <div class="calendar">
                <h2>Set Availability</h2>
                <form id="availability-form">
                    <label for="date">Select Date:</label>
                    <input type="date" id="date" name="date" required>
                        
                    <div class="slots-container" id="slots-container">
                        <div class="slot">
                            <input type="time" name="start-time" placeholder="Start Time" required>
                            <input type="time" name="end-time" placeholder="End Time" required>
                            <button type="button" class="remove-btn" onclick="removeSlot(this)">Remove</button>
                        </div>
                    </div>
                        
                    <button type="button" class="add-btn" onclick="addSlot()">Add More Slots</button>
                    <button type="submit">Save Availability</button>
                </form>
            </div>

            <h2>Generate Meeting Link</h2>
            <label for="meeting-date">Select Meeting Date:</label>
            <input type="date" id="meeting-date" name="meeting-date" required>
            
            <label for="meeting-time">Enter Meeting Time:</label>
            <input type="time" id="meeting-time" name="meeting-time" required>

            <button id="generate-link-btn">Generate Meeting Link</button>

            <div class="link-container" id="link-container"></div>

            <div class="session-container" id="session-container">
                <p>Paid Mentorship Sessions:</p>
            </div>
        </div>
    </div>

    <script>
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            const paramValue = urlParams.get(param);
            
            // Check if paramValue is a stringified object with ObjectId
            if (paramValue && paramValue.includes("ObjectId")) {
                try {
                    const objectIdMatch = paramValue.match(/ObjectId\(['"]([a-fA-F0-9]{24})['"]\)/);
                    if (objectIdMatch && objectIdMatch[1]) {
                        return objectIdMatch[1]; // Return only the extracted ObjectId
                    }
                } catch (error) {
                    console.error('Error parsing ObjectId:', error);
                }
            }

            return paramValue; // Return the plain mentorId if it's not an object
        }

        const mentorId = getQueryParam('mentorId');
        document.getElementById('mentor-id').textContent = `Mentor ID: ${mentorId}`;

        
        document.getElementById('new-post-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Get form values
    const title = document.getElementById('post-title').value;
    const content = document.getElementById('post-content').value;
    const author = document.getElementById('post-author').value;
    const category = document.getElementById('post-category').value;

    // Ensure mentorId is available
    if (!mentorId) {
        alert('Mentor ID is missing.');
        return;
    }

    // Prepare data to send
    const data = {
        title,
        content,
        author,
        category,
        mentorId // Add mentorId to the data object
    };

    try {
        // Send data to the backend
        const response = await fetch(`/mentor/submit-blog/${mentorId}`, { // Correct URL
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (response.ok) {
            alert(result.message);
            document.getElementById('new-post-form').reset(); // Reset form on successful submission
        } else {
            alert('Error submitting blog: ' + result.message);
        }
    } catch (error) {
        console.error("Error submitting blog:", error);
        alert('Error submitting blog');
    }
});


        document.getElementById('availability-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const date = document.getElementById('date').value;
            const slots = Array.from(document.querySelectorAll('.slots-container .slot')).map(slot => {
                const startTime = slot.querySelector('input[name="start-time"]').value;
                const endTime = slot.querySelector('input[name="end-time"]').value;
                return {
                    startTime,
                    endTime,
                    date // Include the date with each slot
                };
            });

            if (!date || slots.some(slot => !slot.startTime || !slot.endTime)) {
                alert('Please fill in all required fields.');
                return;
            }

            const data = {
                date, // This will be used for the availability date
                slots,
                mentorId
            };

            try {
                const response = await fetch('/mentor/availability', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                } else {
                    alert('Error saving availability');
                }
            } catch (error) {
                console.error('Error submitting availability:', error);
            }
        });

        function addSlot() {
            const slotContainer = document.getElementById('slots-container');
            const newSlot = document.createElement('div');
            newSlot.className = 'slot';
            newSlot.innerHTML = `
                <input type="time" name="start-time" placeholder="Start Time" required>
                <input type="time" name="end-time" placeholder="End Time" required>
                <button type="button" class="remove-btn" onclick="removeSlot(this)">Remove</button>
            `;
            slotContainer.appendChild(newSlot);
        }

        function removeSlot(button) {
            const slot = button.closest('.slot');
            slot.remove();
        }

        document.getElementById('generate-link-btn').addEventListener('click', async () => {
            const date = document.getElementById('meeting-date').value;
            const time = document.getElementById('meeting-time').value;

            if (date && time) {
                const data = {
                    date,
                    time,
                    mentorId
                };

                try {
                    const response = await fetch('/mentor/generate-link', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    if (response.ok) {
                        console.log("Meeting link is saved");
                        displaySavedLinks();
                    } else {
                        alert('Error generating link');
                    }
                } catch (error) {
                    console.error('Error generating link:', error);
                }
            } else {
                alert("Please select both date and time.");
            }
        });

        async function displaySavedLinks() {
            try {
                const response = await fetch(`/mentor/availability/${mentorId}`);
                const result = await response.json();

                if (response.ok) {
                    const linkContainer = document.getElementById('link-container');
                    linkContainer.innerHTML = '<p>Saved Meeting Links:</p>';
                    
                    if (Array.isArray(result.meetingLinks)) {
                        result.meetingLinks.forEach(linkObj => {
                            linkContainer.innerHTML += `<a href="${linkObj.link}" target="_blank">${linkObj.link}</a><br>`;
                        });
                    } else {
                        console.error('Expected an array of meetingLinks');
                    }
                } else {
                    console.error('Error fetching links');
                }
            } catch (error) {
                console.error('Error fetching saved links:', error);
            }
        }

        async function displayPaidMentorshipSessions() {
            try {
                const response = await fetch(`/mentor/paid-mentorship-sessions/${mentorId}`);
                const result = await response.json();

                if (response.ok) {
                    const sessionContainer = document.getElementById('session-container');
                    sessionContainer.innerHTML = '<p>Paid Mentorship Sessions:</p>';

                    if (Array.isArray(result.sessions)) {
                        result.sessions.forEach(session => {
                            sessionContainer.innerHTML += `
                                <div>
                                    <p>Link: <a href="${session.link}" target="_blank">${session.link}</a></p>
                                </div>
                            `;
                        });
                    } else {
                        console.error('Expected an array of sessions');
                    }
                } else {
                    console.error('Error fetching paid mentorship sessions');
                }
            } catch (error) {
                console.error('Error fetching paid mentorship sessions:', error);
            }
        }

        displaySavedLinks();
        displayPaidMentorshipSessions();
    </script>
</body>
</html>
